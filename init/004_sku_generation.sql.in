-- ============================================================
-- SKU GENERATION & ENFORCEMENT
-- ============================================================
-- This file defines:
--   1. A global SKU sequence
--   2. Automatic SKU generation on INSERT
--   3. Rejection of manual SKU input
--   4. SKU immutability after creation
-- ============================================================


-- ------------------------------------------------------------
-- GLOBAL SKU SEQUENCE
-- ------------------------------------------------------------
-- Monotonic, never reused, never reset
-- ------------------------------------------------------------

CREATE SEQUENCE sku_global_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


-- ------------------------------------------------------------
-- SKU GENERATION FUNCTION
-- ------------------------------------------------------------
-- Rejects manual SKU input and 
-- generates SKU automatically.
-- ------------------------------------------------------------

CREATE OR REPLACE FUNCTION generate_sku()
RETURNS TRIGGER AS $$
DECLARE
    v_cat_abbr   TEXT;
    v_sub_abbr   TEXT;
    v_fam_abbr   TEXT;
    v_via_abbr   TEXT;
    v_seq        BIGINT;
BEGIN
    -- --------------------------------------------------------
    -- Reject manual SKU input
    -- --------------------------------------------------------
    IF NEW.sku IS NOT NULL THEN
        RAISE EXCEPTION
            'SKU must not be provided manually. It is generated automatically.';
    END IF;

    -- --------------------------------------------------------
    -- Fetch abbreviations (IDs already validated upstream)
    -- --------------------------------------------------------
    SELECT abbreviation INTO v_cat_abbr
      FROM categoria
     WHERE id = NEW.categoria_id;

    SELECT abbreviation INTO v_sub_abbr
      FROM subcategoria
     WHERE id = NEW.subcategoria_id;

    SELECT abbreviation INTO v_fam_abbr
      FROM familia
     WHERE id = NEW.familia_id;

    SELECT abbreviation INTO v_via_abbr
      FROM via_administracion
     WHERE id = NEW.via_administracion_id;

    -- --------------------------------------------------------
    -- Generate global sequence
    -- --------------------------------------------------------
    v_seq := nextval('sku_global_seq');

    -- --------------------------------------------------------
    -- Compose SKU
    -- Format: CAT-SUB-FAM-VIA-000001
    -- --------------------------------------------------------
    NEW.sku :=
        v_cat_abbr || '-' ||
        v_sub_abbr || '-' ||
        v_fam_abbr || '-' ||
        v_via_abbr || '-' ||
        LPAD(v_seq::TEXT, 6, '0');

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- ------------------------------------------------------------
-- SKU GENERATION TRIGGER
-- ------------------------------------------------------------

CREATE TRIGGER trg_004_01_generate_sku
BEFORE INSERT ON productos
FOR EACH ROW
EXECUTE FUNCTION generate_sku();


-- ------------------------------------------------------------
-- SKU IMMUTABILITY ENFORCEMENT
-- ------------------------------------------------------------
-- Prevent any UPDATE that attempts to modify SKU
-- ------------------------------------------------------------

CREATE OR REPLACE FUNCTION prevent_sku_update()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.sku IS DISTINCT FROM OLD.sku THEN
        RAISE EXCEPTION
            'SKU is immutable and cannot be modified.';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER trg_004_02_prevent_sku_update
BEFORE UPDATE ON productos
FOR EACH ROW
EXECUTE FUNCTION prevent_sku_update();
